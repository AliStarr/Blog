@page "/"
@using LinkDotNet.Domain
@using LinkDotNet.Infrastructure.Persistence
@using Markdig
@inject IRepository _repository
@inject AppConfiguration _appConfiguration
@inject NavigationManager _navigationManager

<OgData Title="@(Markdown.ToPlainText(_appConfiguration.BlogName))" 
        AbsolutePreviewImageUrl="@GetAbsolutePreviewImageUrl()"
        Description="@(Markdown.ToPlainText(_appConfiguration.Introduction.Description))"></OgData>
<section>
    <IntroductionCard Introduction="_appConfiguration.Introduction"></IntroductionCard>

    <div class="content px-4">
        @for (var i = 0; i < _blogPosts.Count; i++)
        {
            <ShortBlogPost BlogPost="_blogPosts[i]" UseAlternativeStyle="@(i % 2 != 0)"></ShortBlogPost>
        }
    </div>
</section>
@code {
    IList<BlogPost> _blogPosts = new List<BlogPost>();
    protected override async Task OnInitializedAsync()
    {
        _blogPosts = (await _repository.GetAllAsync(orderBy: b => b.UpdatedDate)).ToList();
    }

    private string GetAbsolutePreviewImageUrl()
    {
        var backgroundUrl = _appConfiguration.Introduction.BackgroundUrl;
        if (IsAbsoluteUrl(backgroundUrl))
        {
            return backgroundUrl;
        }

        var successful = Uri.TryCreate(new Uri(_navigationManager.BaseUri, UriKind.Absolute), new Uri(backgroundUrl, UriKind.RelativeOrAbsolute), out var uri);
        return successful ? uri.ToString() : backgroundUrl;
    }
    
    private bool IsAbsoluteUrl(string url)
    {
        return Uri.TryCreate(url, UriKind.Absolute, out _);
    }
}